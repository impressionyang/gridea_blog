<!DOCTYPE html>
<html lang="zh-CN">
<head><meta charset="UTF-8">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gridea</title>
<link rel="shortcut icon" href="https://impressionyang.vercel.app/favicon.ico?v=1605628453183">
<link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
<link href="//at.alicdn.com/t/font_1806605_dyr0fqhe85.css" rel="stylesheet">
<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://impressionyang.vercel.app/media/css/prism-1.css">
<style>
    @font-face {
        font-weight: normal;
        font-style: normal;
        font-family: 'charganolton';
        src: url('https://impressionyang.vercel.app/media/fonts/Charganolton.ttf');
    }
    @font-face {
        font-weight: normal;
        font-style: normal;
        font-family: 'JetBrainsMono';
        src: url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Regular.eot');
        src: url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Regular.eot?#iefix') format('embedded-opentype'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Regular.woff2') format('woff2'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Regular.woff') format('woff'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Regular.ttf') format('truetype');
    }

    @font-face {
        font-weight: bold;
        font-style: normal;
        font-family: 'JetBrainsMono';
        src: url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Bold.eot');
        src: url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Bold.eot?#iefix') format('embedded-opentype'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Bold.woff2') format('woff2'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Bold.woff') format('woff'),
        url('https://impressionyang.vercel.app/media/fonts/JetBrainsMono-Bold.ttf') format('truetype');
    }
</style>
<link rel="stylesheet" href="https://impressionyang.vercel.app/styles/main.css">

    <script src="https://cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    
        <style>
            pre code {
                background-color: transparent !important;
            }
        </style>
    
</head>
<body>

<div class="header">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="https://impressionyang.vercel.app">
                <img src="https://impressionyang.vercel.app/images/avatar.png?v=1605628453183" width="30" height="30"
                     class="d-inline-block align-top"
                     alt="">
                Gridea
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    
                        
                            <li class="nav-item active">
                                <a class="nav-link" href="/"
                                
                                >首页</a>
                            </li>
                        
                    
                        
                            <li class="nav-item active">
                                <a class="nav-link" href="/archives"
                                
                                >归档</a>
                            </li>
                        
                    
                        
                            <li class="nav-item active">
                                <a class="nav-link" href="/tags"
                                
                                >标签</a>
                            </li>
                        
                    
                        
                            <li class="nav-item active">
                                <a class="nav-link" href="/post/about"
                                
                                >关于</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </nav>
</div>
<div id="content" class="container">
    <div class="row">
        <div class="col-sm-100 col-lg-9">
            <div class="shadow-sm post-detail">
                <article class="post i-card">
                    <h2 class="post-title">
                        C语言二级指针用法之模拟句柄用途
                    </h2>
                    <div class="post-info">
                        <time class="post-time">2020-08-11</time>
                        
                    </div>
                    
                    <div class="post-content">
                        <h2 id="先导">先导</h2>
<blockquote>
<p>因为在学习中使用到了二级指针进行操作，故而作此总结</p>
</blockquote>
<h2 id="提前了解">提前了解</h2>
<h3 id="句柄">句柄</h3>
<ul>
<li>以下词条来自百度百科</li>
</ul>
<blockquote>
<p>句柄（Handle）是一个是用来标识对象或者项目的标识符，可以用来描述窗体、文件等，值得注意的是句柄不能是常量 。<br>
Windows之所以要设立句柄，根本上源于内存管理机制的问题，即虚拟地址。简而言之数据的地址需要变动，变动以后就需要有人来记录、管理变动，因此系统用句柄来记载数据地址的变更。在程序设计中，句柄是一种特殊的智能指针，当一个应用程序要引用其他系统（如数据库、操作系统）所管理的内存块或对象时，就要使用句柄 。</p>
</blockquote>
<h3 id="二级指针">二级指针</h3>
<p>指针是C语言中最高深莫测的部分了，能够直接操作内存的这些指针如果使用得当的话可以完成很多很高效的代码。而二级或者多级指针则能够达到你之前想都不敢想的效果。</p>
<ul>
<li>以下来自于百度百科</li>
</ul>
<blockquote>
<p>A(即B的地址)是指向指针的指针，称为二级指针，用于存放二级指针的变量称为二级指针变量．根据B的不同情况，二级指针又分为指向指针变量的指针和指向数组的指针。</p>
</blockquote>
<!-- more -->
<h2 id="提出需求">提出需求</h2>
<p>这次总结的内容则是将指针当做句柄放进函数当形参是<strong>动态地申请空间</strong>来用作其他用途的。</p>
<p>首先，我们要知道，我们如果直接把指针变量的地址当做函数的实参，去在函数里面申请空间，由于形参定义是一级指针，是无法拿到动态申请的空间的，以下就是一个实例</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

static void get_space(int* p)
{
    p = (int *)malloc(sizeof(int));
    *p = 16;
}

int main()
{
    int a = 10;
    int* pa = &amp;a;
    printf(&quot;*pa=%d \t pa=%p \n&quot;, *pa, pa);
    
    get_space(&amp;pa);
    printf(&quot;*pa=%d \t pa=%p \n&quot;, *pa, pa);
    get_space(pa);
    printf(&quot;*pa=%d \t pa=%p \n&quot;, *pa, pa);
    return 0;
}
</code></pre>
<p>运行得到以下结果</p>
<figure data-type="image" tabindex="1"><img src="https://impressionyang.gitee.io/imgbed/img/blog/pointer_level2_1.png" alt="pointer level2 1" loading="lazy"></figure>
<p>显然，这个结果正和上面所说的，在<code>main</code>函数传进去的实参，无论是指针变量还是地址，在函数里面的操作并不能通过一级指针的形参返回动态申请的空间，这样做很容易出现野指针现象。</p>
<p>原因其实很简单，在形参定义的一级指针变量只是有从实参传递过来的地址而已，无论是<strong>指针变量内的地址</strong>还是<strong>指针变量本身的地址</strong>，只是存在形参一级指针变量当中，正如上面表现的，不管指针变量<code>p</code>的内容是<code>pa</code>或者<code>pa的地址</code>，只要使用<code>p</code>去获取空间的地址，便会使得指针<code>p</code>的内容从<code>pa</code>或者<code>pa的地址</code>变成新空间的地址，而在<code>main</code>函数中的<code>pa</code>并没有被影响到。</p>
<p><strong>注意：上面的情况不要尝试用<code>*p</code>配合实参是<code>pa的地址</code>来接受新空间，会造成段错误，因为那样就是用一个<code>int</code>型的变量去接受一个<code>int*</code>型的值了</strong></p>
<p>那么，如果我想通过指针去在函数中获取动态的空间要如何操作</p>
<h2 id="解决方案">解决方案</h2>
<p>其实通过上面的注意事项已经有一点眉目了，要想使用<code>*</code>符号来提取地址内容的方法来获得修改主函数传递的指针变量的内容权限的原理就是使得<code>*p</code>能够代表一个地址。由此可见，指针的指针那就是二级指针了，表现在代码中就是将上述的形参定义为二级指针并使用主函数的一级指针变量去传递参数。</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

static void get_space(int** p)
{
    *p = (int *)malloc(sizeof(int));
    int* temp = *p;
    *temp = 66;
}

int main()
{
    int a = 10;
    int* pa = &amp;a;
    printf(&quot;*pa=%d \t pa=%p \n&quot;, *pa, pa);

    get_space(&amp;pa);
    printf(&quot;*pa=%d \t pa=%p \n&quot;, *pa, pa);
    return 0;
}
</code></pre>
<p>运行得到以下结果：</p>
<figure data-type="image" tabindex="2"><img src="https://impressionyang.gitee.io/imgbed/img/blog/pointer_level2_2.png" alt="pointer level2 2" loading="lazy"></figure>
<p>由此便能通过一个指针在函数中去动态申请空间并返回上一层中了。</p>
<h2 id="应用场景">应用场景</h2>
<p>光是看上面的例子并不能了解这种方法的强大之处，但是模仿上面所说的句柄的思想，来举例说说这个方案的好处吧。</p>
<p>首先假设，你负责一个项目的某个模块的编写，需要编写出<em>测试app</em>，<em>模块实现</em>以及<em>该模块所需的协议</em>，并且为了减少各个方法与模块之间的耦合性以及代码的简洁效率等因素不允许大量使用全局变量，但是你要完成这个模块有需要很多的变量来存储一些参数以供该模块实现内的各个方法进行调用，这时候要怎么解决呢？</p>
<p>结构体是解决这种变量多的一种方案，但是如果在模块内使用全局变量的话你又如何管理这些空间呢（如果里面有较大的空间占用），只能等程序结束时清除吗</p>
<p>这时候使用一个指针变量来保存一个动态空间的地址来进行操作显然更方便，也就是使用一个<code>void*</code>型指针变量来存储地址，在模块初始化时申请空间，模块进行功能时将地址下放，用完后动态地清理该空间。而这个<code>void*</code>型的指针就是本次提出的句柄的模仿。</p>
<p>光是空口说出有点不太好说明该方案的可行性，下面用一个小例子来证明：</p>
<ul>
<li>假设下面的主函数函数和其他函数不在同一文件中</li>
</ul>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;


typedef struct couple_num
{
    int a;
    char b;
} couple_num_t;

void get_space(void** a)
{
    printf(&quot;*a addr:%p\n&quot;, *a);
    *a = (couple_num_t *) malloc (sizeof(couple_num_t));
    printf(&quot;%p\n&quot;, a);
    couple_num_t *p = *a;
    p-&gt;a = 1000;
    p-&gt;b = 'r';
}

void show(void *a)
{
    printf(&quot;*a addr:%p\n&quot;, a);
    couple_num_t* temp = a;
    printf(&quot;show:\n%d\n%c\n&quot;,temp-&gt;a, temp-&gt;b);
}

void release(void** a)
{
    free(*a);
}

int main()
{
    void *p = NULL;

    printf(&quot;origin p addr:%p\n&quot;, p);

    get_space(&amp;p);
    printf(&quot;after change p addr:%p\n&quot;, p);

    couple_num_t* temp = p;
    printf(&quot;temp:%d\n&quot;,temp-&gt;a);

    show(p);

    release(&amp;p);
    printf(&quot;after release p addr：%p\n&quot;, p);
    
    show(p);

    getchar();

    return 0;
}
</code></pre>
<p>运行结果如下：</p>
<figure data-type="image" tabindex="3"><img src="https://impressionyang.gitee.io/imgbed/img/blog/pointer_level2_3.png" alt="pointer level2 3" loading="lazy"></figure>
<p>可以看到，使用这种方法，不用在主函数暴露结构体内容，也能够将结构体的地址空间进行掌握，高效的利用了指针的特性完成功能，使得各个方法之间相互影响减少，参数传递也简单，并且在使用完成后还能动态清除空间。</p>
<h2 id="后记">后记</h2>
<p>这种方法在C语言下设计功能模块时特别有用，模仿了面向对象的句柄思想，减少模块间的耦合（不使用全局变量，各方法就不会无意间相互干扰了）。</p>
<hr>
<center><img src="https://impressionyang.gitee.io/imgbed/img/favicon/favicon_64.png" /></center>
<center>impressionyang</center>

                    </div>
                </article>
            </div>
            <div class="row">
                <div class="next-post col-6">
                    
                        <div class="next">上一篇</div>
                        <a href="https://impressionyang.vercel.app/post/compress-file-extract-and-compress/">
                            <h3 class="post-title">
                                Linux解压缩文件
                            </h3>
                        </a>
                    
                </div>
                <div class="next-post col-6">
                    
                        <div class="next">下一篇</div>
                        <a href="https://impressionyang.vercel.app/post/add-canvas-clock-in-pugjs/">
                            <h3 class="post-title">
                                给pugjs的stun主题添加canvas时钟
                            </h3>
                        </a>
                    
                </div>
            </div>
            
                <div id="valinecomments"></div>
            
        </div>
        <div class="d-none d-lg-block col-lg-3">
            
                <div class="toc-card i-card shadow-sm sticky-top">
    <div class="toc-title i-card-title">目录</div>
    <div class="toc-content">
        <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%85%88%E5%AF%BC">先导</a></li>
<li><a href="#%E6%8F%90%E5%89%8D%E4%BA%86%E8%A7%A3">提前了解</a>
<ul>
<li><a href="#%E5%8F%A5%E6%9F%84">句柄</a></li>
<li><a href="#%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88">二级指针</a></li>
</ul>
</li>
<li><a href="#%E6%8F%90%E5%87%BA%E9%9C%80%E6%B1%82">提出需求</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>
<li><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">应用场景</a></li>
<li><a href="#%E5%90%8E%E8%AE%B0">后记</a></li>
</ul>
</li>
</ul>

    </div>
    <script>
        function locateCatelogList() {
            /*获取文章目录集合,可通过:header过滤器*/
            var alis = $('.post-content :header');
            /*获取侧边栏目录列表集合**/
            var sidebar_alis = $('.markdownIt-TOC a');
            /*获取滚动条到顶部的距离*/
            var scroll_height = $(window).scrollTop();
            for (var i = 0; i < alis.length; i++) {
                /*获取锚点集合中的元素分别到顶点的距离*/
                var a_height = $(alis[i]).offset().top-150;
                if (a_height < scroll_height) {
                    /*高亮显示*/
                    sidebar_alis.removeClass('on');
                    $(sidebar_alis[i]).addClass('on');
                }
            }
        }

        $(function () {
            /*绑定滚动事件 */
            $(window).bind('scroll', locateCatelogList);
        });
    </script>
</div>

            
        </div>
    </div>
    <div class="site-footer">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | Theme <a href="//github.com/violetfreesia/gridea-theme-Violet" target="_blank">Violet</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <script src="https://impressionyang.vercel.app/media/js/main.js"></script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>














</div>

    <script>
    new Valine({
        el: '#valinecomments',
        appId: '9bGYviz3w1u6szxQMQKJ3Jt7-gzGzoHsz',
        appKey: 'tmtw09Txojf9t5xd1DWlJ7jy',
        placeholder: '畅所欲言吧,可以留下联系方式哦~',
        pageSize: 10,
        lang: 'zh-CN',
        
        
        requiredFields: []
    })
</script>
    <script>
        $('#valinecomments .vpower').remove();
    </script>


    <script>
        $('pre').addClass('line-numbers')
    </script>

</body>
</html>